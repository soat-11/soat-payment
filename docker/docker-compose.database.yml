services:
  mongo:
    image: mongo:6-jammy
    container_name: payment-mongo
    ports:
      - '27017:27017'
    volumes:
      - mongo-data:/data/db
    networks:
      - payment-network
    restart: unless-stopped
    healthcheck:
      test:
        ['CMD', 'mongosh', '--quiet', '--eval', "db.adminCommand('ping').ok"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev
      - observability

  # MongoDB Exporter (para mÃ©tricas no Prometheus)
  # mongo-exporter:
  #   image: percona/mongodb_exporter:0.40
  #   container_name: mongo-exporter
  #   command:
  #     - '--mongodb.uri=mongodb://mongo:27017'
  #     - '--discovering-mode'
  #     - '--collect-all'
  #   ports:
  #     - '9216:9216'
  #   depends_on:
  #     mongo:
  #       condition: service_healthy
  #   networks:
  #     - payment-network
  #   restart: unless-stopped
  #   profiles:
  #     - dev
  #     - observability

  # Mongo Express (UI)
  mongo-express:
    image: mongo-express:latest
    container_name: payment-mongo-express
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongo:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    ports:
      - '8081:8081'
    depends_on:
      - mongo
    networks:
      - payment-network
    restart: unless-stopped
    profiles:
      - dev

  # MongoDB Replica Set - Secondary
  mongo2:
    image: mongo:6-jammy
    container_name: payment-mongo2
    command: ['--replSet', 'rs0', '--bind_ip_all', '--port', '27018']
    ports:
      - '27018:27018'
    volumes:
      - mongo2-data:/data/db
    networks:
      - payment-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD',
          'mongosh',
          '--quiet',
          '--port',
          '27018',
          '--eval',
          "db.adminCommand('ping').ok",
        ]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - observability

  # MongoDB Replica Set Init
  mongo-init:
    image: mongo:6-jammy
    container_name: mongo-init
    depends_on:
      mongo:
        condition: service_healthy
      mongo2:
        condition: service_healthy
    networks:
      - payment-network
    profiles:
      - observability
    entrypoint: >
      bash -c "
        echo 'Waiting for MongoDB instances to be ready...';
        sleep 10;

        # Check if replica set is already initialized
        if mongosh --host mongo:27017 --quiet --eval 'rs.status().ok' 2>/dev/null | grep -q 1; then
          echo 'Replica set already initialized';
          exit 0;
        fi;

        echo 'Initiating replica set...';
        mongosh --host mongo:27017 <<EOF
        rs.initiate({
          _id: 'rs0',
          members: [
            { _id: 0, host: 'mongo:27017', priority: 2 },
            { _id: 1, host: 'mongo2:27018', priority: 1 }
          ]
        });
        EOF

        echo 'Waiting for replica set to be ready...';
        sleep 10;

        mongosh --host mongo:27017 --eval 'rs.status()';
        echo 'Replica set initialized successfully!';
      "

  # Mongo Express para Replica Set
  mongo-express-replica:
    image: mongo-express:latest
    container_name: payment-mongo-express-replica
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongo:27017,mongo2:27018/?replicaSet=rs0
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    ports:
      - '8082:8081'
    depends_on:
      mongo:
        condition: service_healthy
      mongo2:
        condition: service_healthy
    networks:
      - payment-network
    restart: unless-stopped
    profiles:
      - observability
